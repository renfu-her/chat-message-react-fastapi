# å¯¦æ™‚é€šä¿¡æ–¹æ¡ˆæ¯”è¼ƒèˆ‡æ¨è–¦

æœ¬æ–‡æª”æ¯”è¼ƒä¸åŒçš„å¯¦æ™‚é€šä¿¡æ–¹æ¡ˆï¼Œä¸¦æ ¹æ“šèŠå¤©æ‡‰ç”¨çš„éœ€æ±‚æä¾›æ¨è–¦ã€‚

## ç•¶å‰æ–¹æ¡ˆï¼šWebSocket

### å„ªé»
- âœ… **é›™å‘é€šä¿¡**ï¼šå®¢æˆ¶ç«¯å’Œæœå‹™å™¨éƒ½å¯ä»¥ä¸»å‹•ç™¼é€æ¶ˆæ¯
- âœ… **ä½å»¶é²**ï¼šå»ºç«‹é€£æ¥å¾Œï¼Œæ¶ˆæ¯å‚³è¼¸å¹¾ä¹å³æ™‚
- âœ… **é«˜æ•ˆ**ï¼šä¸éœ€è¦ HTTP è«‹æ±‚é ­ï¼Œé–‹éŠ·å°
- âœ… **æ”¯æŒäºŒé€²åˆ¶æ•¸æ“š**ï¼šå¯ä»¥å‚³è¼¸åœ–ç‰‡ã€æ–‡ä»¶ç­‰
- âœ… **æ¨™æº–å”è­°**ï¼šå»£æ³›æ”¯æŒï¼Œç€è¦½å™¨å’Œæœå‹™å™¨éƒ½æœ‰è‰¯å¥½æ”¯æŒ

### ç¼ºé»
- âŒ **é€£æ¥ç®¡ç†è¤‡é›œ**ï¼šéœ€è¦è™•ç†æ–·ç·šé‡é€£ã€å¿ƒè·³æª¢æ¸¬ç­‰
- âŒ **ä»£ç†/è² è¼‰å‡è¡¡é…ç½®**ï¼šéœ€è¦ç‰¹æ®Šé…ç½®ï¼ˆå¦‚ Nginxï¼‰
- âŒ **é˜²ç«ç‰†å•é¡Œ**ï¼šæŸäº›ä¼æ¥­é˜²ç«ç‰†å¯èƒ½é˜»æ­¢ WebSocket
- âŒ **è³‡æºæ¶ˆè€—**ï¼šæ¯å€‹é€£æ¥éƒ½éœ€è¦ä¿æŒæ‰“é–‹ç‹€æ…‹

### é©ç”¨å ´æ™¯
- èŠå¤©æ‡‰ç”¨ï¼ˆé›™å‘é€šä¿¡ï¼‰
- å¯¦æ™‚å”ä½œå·¥å…·
- åœ¨ç·šéŠæˆ²
- å¯¦æ™‚æ•¸æ“šç›£æ§

---

## æ–¹æ¡ˆ 1ï¼šServer-Sent Events (SSE)

### å„ªé»
- âœ… **ç°¡å–®æ˜“ç”¨**ï¼šåŸºæ–¼ HTTPï¼Œé…ç½®ç°¡å–®
- âœ… **è‡ªå‹•é‡é€£**ï¼šç€è¦½å™¨è‡ªå‹•è™•ç†é€£æ¥æ–·é–‹å’Œé‡é€£
- âœ… **HTTP å…¼å®¹æ€§å¥½**ï¼šä¸éœ€è¦ç‰¹æ®Šä»£ç†é…ç½®
- âœ… **æœå‹™å™¨æ¨é€**ï¼šæœå‹™å™¨å¯ä»¥ä¸»å‹•æ¨é€æ•¸æ“šåˆ°å®¢æˆ¶ç«¯

### ç¼ºé»
- âŒ **å–®å‘é€šä¿¡**ï¼šåªèƒ½æœå‹™å™¨åˆ°å®¢æˆ¶ç«¯ï¼Œå®¢æˆ¶ç«¯ç™¼é€éœ€è¦é¡å¤–çš„ HTTP è«‹æ±‚
- âŒ **åªæ”¯æŒæ–‡æœ¬**ï¼šä¸æ”¯æŒäºŒé€²åˆ¶æ•¸æ“š
- âŒ **é€£æ¥æ•¸é™åˆ¶**ï¼šç€è¦½å™¨å°åŒä¸€åŸŸåæœ‰é€£æ¥æ•¸é™åˆ¶ï¼ˆé€šå¸¸ 6 å€‹ï¼‰

### é©ç”¨å ´æ™¯
- å¯¦æ™‚é€šçŸ¥ï¼ˆå–®å‘ï¼‰
- å¯¦æ™‚æ•¸æ“šæµï¼ˆå¦‚è‚¡ç¥¨åƒ¹æ ¼ï¼‰
- æœå‹™å™¨ç‹€æ…‹æ¨é€
- **ä¸é©åˆèŠå¤©æ‡‰ç”¨**ï¼ˆéœ€è¦é›™å‘é€šä¿¡ï¼‰

### å¯¦ç¾ç¤ºä¾‹ï¼ˆFastAPIï¼‰
```python
from fastapi import APIRouter
from fastapi.responses import StreamingResponse
import asyncio
import json

router = APIRouter()

async def event_generator():
    while True:
        # æª¢æŸ¥æ˜¯å¦æœ‰æ–°æ¶ˆæ¯
        if has_new_message():
            yield f"data: {json.dumps(message)}\n\n"
        await asyncio.sleep(0.1)

@router.get("/events")
async def stream_events():
    return StreamingResponse(
        event_generator(),
        media_type="text/event-stream"
    )
```

---

## æ–¹æ¡ˆ 2ï¼šLong Pollingï¼ˆé•·è¼ªè©¢ï¼‰

### å„ªé»
- âœ… **ç°¡å–®å¯¦ç¾**ï¼šåŸºæ–¼æ¨™æº– HTTPï¼Œå®¹æ˜“å¯¦ç¾
- âœ… **å…¼å®¹æ€§å¥½**ï¼šæ‰€æœ‰ç€è¦½å™¨å’Œä»£ç†éƒ½æ”¯æŒ
- âœ… **ç„¡éœ€ç‰¹æ®Šé…ç½®**ï¼šä¸éœ€è¦ä¿®æ”¹ Nginx ç­‰é…ç½®

### ç¼ºé»
- âŒ **é«˜å»¶é²**ï¼šéœ€è¦ç­‰å¾…è«‹æ±‚è¶…æ™‚æˆ–æ–°æ•¸æ“šåˆ°é”
- âŒ **æœå‹™å™¨è³‡æºæ¶ˆè€—**ï¼šéœ€è¦ä¿æŒå¤§é‡ HTTP é€£æ¥æ‰“é–‹
- âŒ **æ•ˆç‡è¼ƒä½**ï¼šæ¯å€‹è«‹æ±‚éƒ½æœ‰ HTTP é ­é–‹éŠ·
- âŒ **é›™å‘é€šä¿¡è¤‡é›œ**ï¼šéœ€è¦å…©å€‹é€£æ¥ï¼ˆä¸€å€‹ç”¨æ–¼æ¥æ”¶ï¼Œä¸€å€‹ç”¨æ–¼ç™¼é€ï¼‰

### é©ç”¨å ´æ™¯
- ç°¡å–®çš„å¯¦æ™‚æ›´æ–°éœ€æ±‚
- ä¸æ”¯æŒ WebSocket çš„ç’°å¢ƒ
- **ä¸æ¨è–¦ç”¨æ–¼èŠå¤©æ‡‰ç”¨**ï¼ˆæ•ˆç‡ä½ï¼‰

### å¯¦ç¾ç¤ºä¾‹ï¼ˆFastAPIï¼‰
```python
@router.get("/poll")
async def long_poll():
    # ç­‰å¾…æ–°æ¶ˆæ¯æˆ–è¶…æ™‚ï¼ˆ30ç§’ï¼‰
    message = await wait_for_message(timeout=30)
    if message:
        return {"data": message}
    return {"data": None}
```

---

## æ–¹æ¡ˆ 3ï¼šShort Pollingï¼ˆçŸ­è¼ªè©¢ï¼‰

### å„ªé»
- âœ… **æœ€ç°¡å–®**ï¼šå®šæœŸç™¼é€ HTTP è«‹æ±‚
- âœ… **ç„¡ç‹€æ…‹**ï¼šä¸éœ€è¦ç¶­è­·é€£æ¥
- âœ… **å…¼å®¹æ€§æœ€å¥½**ï¼šä»»ä½•ç’°å¢ƒéƒ½æ”¯æŒ

### ç¼ºé»
- âŒ **é«˜å»¶é²**ï¼šå–æ±ºæ–¼è¼ªè©¢é–“éš”
- âŒ **æœå‹™å™¨è² è¼‰é«˜**ï¼šé »ç¹çš„ HTTP è«‹æ±‚
- âŒ **è³‡æºæµªè²»**ï¼šå³ä½¿æ²’æœ‰æ–°æ•¸æ“šä¹Ÿæœƒç™¼é€è«‹æ±‚
- âŒ **é›»æ± æ¶ˆè€—**ï¼šç§»å‹•è¨­å‚™ä¸Šæœƒå¿«é€Ÿæ¶ˆè€—é›»æ± 

### é©ç”¨å ´æ™¯
- æ›´æ–°é »ç‡ä½çš„å ´æ™¯
- ç°¡å–®çš„ç‹€æ…‹æª¢æŸ¥
- **ä¸æ¨è–¦ç”¨æ–¼èŠå¤©æ‡‰ç”¨**ï¼ˆæ•ˆç‡å¤ªä½ï¼‰

### å¯¦ç¾ç¤ºä¾‹
```javascript
// å‰ç«¯æ¯ 2 ç§’è¼ªè©¢ä¸€æ¬¡
setInterval(async () => {
  const messages = await fetch('/api/messages/latest');
  // è™•ç†æ¶ˆæ¯
}, 2000);
```

---

## æ–¹æ¡ˆ 4ï¼šæ··åˆæ–¹æ¡ˆï¼ˆæ¨è–¦ï¼‰

### WebSocket + HTTP å‚™ç”¨æ–¹æ¡ˆ

çµåˆ WebSocket çš„æ•ˆç‡å’Œ HTTP çš„å¯é æ€§ï¼š

1. **ä¸»è¦ä½¿ç”¨ WebSocket**ï¼šç”¨æ–¼å¯¦æ™‚é›™å‘é€šä¿¡
2. **HTTP ä½œç‚ºå‚™ç”¨**ï¼šç•¶ WebSocket é€£æ¥å¤±æ•—æ™‚ï¼Œé™ç´šåˆ° Long Polling æˆ– Short Polling
3. **è‡ªå‹•åˆ‡æ›**ï¼šæª¢æ¸¬åˆ° WebSocket ä¸å¯ç”¨æ™‚è‡ªå‹•åˆ‡æ›

### å„ªé»
- âœ… **æœ€ä½³é«”é©—**ï¼šWebSocket å¯ç”¨æ™‚æä¾›æœ€ä½³æ€§èƒ½
- âœ… **é«˜å¯é æ€§**ï¼šWebSocket å¤±æ•—æ™‚è‡ªå‹•é™ç´š
- âœ… **å…¼å®¹æ€§å¥½**ï¼šé©ç”¨æ–¼å„ç¨®ç¶²çµ¡ç’°å¢ƒ

### å¯¦ç¾ç­–ç•¥
```typescript
// å‰ç«¯ç¤ºä¾‹
class RealtimeConnection {
  private ws: WebSocket | null = null;
  private fallbackTimer: NodeJS.Timeout | null = null;
  private useWebSocket = true;

  connect() {
    try {
      this.ws = new WebSocket(url);
      this.ws.onerror = () => {
        // WebSocket å¤±æ•—ï¼Œåˆ‡æ›åˆ°å‚™ç”¨æ–¹æ¡ˆ
        this.useWebSocket = false;
        this.startLongPolling();
      };
    } catch (e) {
      this.startLongPolling();
    }
  }

  startLongPolling() {
    this.fallbackTimer = setInterval(async () => {
      const messages = await this.fetchNewMessages();
      this.handleMessages(messages);
    }, 2000);
  }
}
```

---

## æ–¹æ¡ˆæ¯”è¼ƒè¡¨

| æ–¹æ¡ˆ | å»¶é² | é›™å‘é€šä¿¡ | å¯¦ç¾é›£åº¦ | æœå‹™å™¨è² è¼‰ | ç€è¦½å™¨æ”¯æŒ | æ¨è–¦åº¦ |
|------|------|----------|----------|------------|------------|--------|
| **WebSocket** | â­â­â­â­â­ | âœ… | â­â­â­ | â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ |
| **SSE** | â­â­â­â­ | âŒ | â­â­ | â­â­â­ | â­â­â­â­â­ | â­â­â­ |
| **Long Polling** | â­â­â­ | âœ… | â­â­â­ | â­â­ | â­â­â­â­â­ | â­â­ |
| **Short Polling** | â­ | âœ… | â­ | â­ | â­â­â­â­â­ | â­ |
| **æ··åˆæ–¹æ¡ˆ** | â­â­â­â­â­ | âœ… | â­â­â­â­ | â­â­â­ | â­â­â­â­â­ | â­â­â­â­â­ |

---

## é‡å°èŠå¤©æ‡‰ç”¨çš„æ¨è–¦

### ğŸ† æœ€ä½³æ–¹æ¡ˆï¼šWebSocketï¼ˆç•¶å‰æ–¹æ¡ˆï¼‰

**ç†ç”±**ï¼š
1. èŠå¤©æ‡‰ç”¨éœ€è¦**é›™å‘å¯¦æ™‚é€šä¿¡**
2. **ä½å»¶é²**å°èŠå¤©é«”é©—è‡³é—œé‡è¦
3. ç¾ä»£ç€è¦½å™¨å’Œæœå‹™å™¨éƒ½**è‰¯å¥½æ”¯æŒ**
4. å¯ä»¥å‚³è¼¸**åœ–ç‰‡ã€æ–‡ä»¶**ç­‰äºŒé€²åˆ¶æ•¸æ“š

### ğŸ¥ˆ å‚™é¸æ–¹æ¡ˆï¼šæ··åˆæ–¹æ¡ˆï¼ˆWebSocket + Long Pollingï¼‰

**é©ç”¨å ´æ™¯**ï¼š
- éœ€è¦æ”¯æŒ**èˆŠç‰ˆç€è¦½å™¨**æˆ–**ç‰¹æ®Šç¶²çµ¡ç’°å¢ƒ**
- éœ€è¦**æ›´é«˜çš„å¯é æ€§**
- é¡˜æ„å¢åŠ **å¯¦ç¾è¤‡é›œåº¦**ä»¥æ›å–æ›´å¥½çš„å…¼å®¹æ€§

### ä¸æ¨è–¦çš„æ–¹æ¡ˆ

- âŒ **ç´” SSE**ï¼šä¸æ”¯æŒé›™å‘é€šä¿¡ï¼Œä¸é©åˆèŠå¤©
- âŒ **ç´” Long Polling**ï¼šæ•ˆç‡ä½ï¼Œå»¶é²é«˜
- âŒ **ç´” Short Polling**ï¼šæ•ˆç‡å¤ªä½ï¼Œä¸é©åˆå¯¦æ™‚æ‡‰ç”¨

---

## å„ªåŒ–å»ºè­°

### 1. WebSocket é€£æ¥å„ªåŒ–

```python
# æ·»åŠ å¿ƒè·³æª¢æ¸¬
async def handle_websocket(websocket: WebSocket):
    await websocket.accept()
    
    # ç™¼é€å¿ƒè·³
    async def heartbeat():
        while True:
            await asyncio.sleep(30)  # æ¯ 30 ç§’
            try:
                await websocket.send_json({"type": "ping"})
            except:
                break
    
    asyncio.create_task(heartbeat())
```

### 2. è‡ªå‹•é‡é€£æ©Ÿåˆ¶

```typescript
// å‰ç«¯è‡ªå‹•é‡é€£
class WebSocketManager {
  private reconnectAttempts = 0;
  private maxReconnectAttempts = 5;

  connect() {
    this.ws = new WebSocket(url);
    
    this.ws.onclose = () => {
      if (this.reconnectAttempts < this.maxReconnectAttempts) {
        setTimeout(() => {
          this.reconnectAttempts++;
          this.connect();
        }, 1000 * this.reconnectAttempts);
      }
    };
  }
}
```

### 3. æ¶ˆæ¯éšŠåˆ—å’Œç¢ºèªæ©Ÿåˆ¶

```python
# å¾Œç«¯æ¶ˆæ¯ç¢ºèª
class MessageQueue:
    def __init__(self):
        self.pending_messages = {}
    
    async def send_with_ack(self, websocket, message):
        message_id = str(uuid.uuid4())
        message['id'] = message_id
        self.pending_messages[message_id] = message
        
        await websocket.send_json(message)
        
        # ç­‰å¾…ç¢ºèªï¼ˆè¶…æ™‚ 5 ç§’ï¼‰
        await asyncio.wait_for(
            self.wait_for_ack(message_id),
            timeout=5.0
        )
```

---

## çµè«–

å°æ–¼èŠå¤©æ‡‰ç”¨ï¼Œ**WebSocket æ˜¯æœ€ä½³é¸æ“‡**ã€‚ç•¶å‰å¯¦ç¾å·²ç¶“å¾ˆå¥½ï¼Œå»ºè­°ï¼š

1. âœ… **ç¹¼çºŒä½¿ç”¨ WebSocket**ä½œç‚ºä¸»è¦æ–¹æ¡ˆ
2. âœ… **å„ªåŒ–é€£æ¥ç®¡ç†**ï¼ˆå¿ƒè·³ã€é‡é€£ã€éŒ¯èª¤è™•ç†ï¼‰
3. âš ï¸ **å¯é¸**ï¼šæ·»åŠ  Long Polling ä½œç‚ºå‚™ç”¨æ–¹æ¡ˆï¼ˆå¦‚æœéœ€è¦æ”¯æŒç‰¹æ®Šç’°å¢ƒï¼‰
4. âœ… **ç›£æ§å’Œæ—¥èªŒ**ï¼šè¿½è¹¤é€£æ¥ç‹€æ…‹å’ŒéŒ¯èª¤

å¦‚æœéœ€è¦ï¼Œæˆ‘å¯ä»¥å¹«æ‚¨å¯¦ç¾ï¼š
- å¿ƒè·³æª¢æ¸¬æ©Ÿåˆ¶
- è‡ªå‹•é‡é€£å„ªåŒ–
- æ··åˆæ–¹æ¡ˆï¼ˆWebSocket + å‚™ç”¨ï¼‰
- æ¶ˆæ¯ç¢ºèªæ©Ÿåˆ¶

